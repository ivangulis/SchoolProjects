package controller;

import java.io.IOException;

import javax.naming.Context;
import javax.naming.InitialContext;
import javax.naming.NamingException;

import org.joda.time.DateTime;
import org.joda.time.LocalTime;

import application.Main;
import entity2.Film;
import entity2.Response;
import entity2.User;
import facade.ProgramFacadeBeanRemote;
import javafx.event.ActionEvent;
import javafx.fxml.FXML;
import javafx.scene.control.Menu;
import javafx.scene.control.MenuItem;
import javafx.scene.control.TableColumn;
import javafx.scene.control.TableView;
import javafx.scene.control.cell.PropertyValueFactory;
import table.FilmTable;

public class MainScreenController implements InitUser {

	@FXML
	private MenuItem changeStations_menuItem;
	@FXML
	private MenuItem reloadProgram_menuItem;
	@FXML
	private MenuItem changeLangEN_menuItem;
	@FXML
	private MenuItem changeLangSK_menuItem;
	@FXML
	private Menu user_menu;
	@FXML
	private MenuItem changePassword_menuItem;
	@FXML
	private MenuItem logout_menuItem;
	@FXML
	private TableView<FilmTable> Schedule_tableView;
	@FXML
	private TableColumn<FilmTable, LocalTime> start_tableColumn;
	@FXML
	private TableColumn<FilmTable, LocalTime> end_tableColumn;
	@FXML
	private TableColumn<FilmTable, String> name_tableColumn;

	private User user;

	public void initUser(User user) {
		this.user = user;
		user_menu.setText(user.getUsername());
		start_tableColumn.setCellValueFactory(new PropertyValueFactory<FilmTable, LocalTime>("start_time"));
		end_tableColumn.setCellValueFactory(new PropertyValueFactory<FilmTable, LocalTime>("end_time"));
		name_tableColumn.setCellValueFactory(new PropertyValueFactory<FilmTable, String>("name"));
	}

	// Event Listener on MenuItem[#changeStations_menuItem].onAction
	@FXML
	public void changeStations(ActionEvent event) {
		try {
			String fxml = Main.getInstance().getProperties().getProperty("ChangeStationsFXML");
			String title = Main.getInstance().getLanguage().getText("ChangeStationsTitle");
			Main.getInstance().getWindowController().openInitWaitWindow(user, fxml, title);
		} catch (IOException e) {
			// TODO Auto-generated catch block
			e.printStackTrace(); //TODO logger, ked sa nepodari otvorit NewAcc
		}
	}

	// Event Listener on MenuItem[#reloadProgram_menuItem].onAction
	@FXML
	public void reloadProgram(ActionEvent event) {
		Context ctx = null;
		Schedule_tableView.getItems().clear();
		try {
			ctx = new InitialContext();
			ProgramFacadeBeanRemote remote = (ProgramFacadeBeanRemote) ctx.lookup("ProjectEAR/ProjectServer//ProgramFacadeBean!facade.ProgramFacadeBeanRemote");
			DateTime date = new DateTime();
			Response response = remote.loadProgram(user, date);
			for (Film f: response.getTvDays().get(0).getFilms()) {
				String name = f.getName();
				LocalTime start = f.getStart_time();
				LocalTime end = f.getEnd_time();
				FilmTable filmTable = new FilmTable(name, start, end);
				Schedule_tableView.getItems().add(filmTable);
			}
		} catch (NamingException e) {
			e.printStackTrace(); //TODO loger
		} finally {
			try {
				ctx.close();
			} catch (NamingException e) {
				// TODO Auto-generated catch block
				e.printStackTrace(); //TODO loger
			}
		} //TODO load program a load svoje data, na jeden trip
	}

	// Event Listener on MenuItem[#changeLangEN_menuItem].onAction
	@FXML
	public void changeLangEN(ActionEvent event) {
		// TODO Autogenerated
	}

	// Event Listener on MenuItem[#changeLangSK_menuItem].onAction
	@FXML
	public void changeLangSK(ActionEvent event) {
		// TODO Autogenerated
	}

	// Event Listener on MenuItem[#changePassword_menuItem].onAction
	@FXML
	public void changePassword(ActionEvent event) {
		// TODO Autogenerated
	}

	// Event Listener on MenuItem[#logout_menuItem].onAction
	@FXML
	public void logout(ActionEvent event) {
		String text = Main.getInstance().getLanguage().getText("ConfirmLogout");
		boolean confirm = Main.getInstance().getWindowController().confirm(text);
		if (confirm) {
			try {
				String fxml = Main.getInstance().getProperties().getProperty("LoginFXML");
				String title = Main.getInstance().getLanguage().getText("LoginTitle");
				Main.getInstance().getWindowController().openWindow(fxml, title);
				fxml = Main.getInstance().getProperties().getProperty("MainScreenFXML");
				Main.getInstance().getWindowController().closeWindow(fxml);
			} catch (IOException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
		}
		// TODO Autogenerated, savenut program alebo sa aspon spytat ci ho savenut
	}

}
